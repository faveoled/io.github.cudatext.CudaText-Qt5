app-id: io.github.cudatext.CudaText-Qt5
runtime: org.kde.Platform
runtime-version: '5.15-22.08'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.freepascal
build-options:
  append-path: /usr/lib/sdk/freepascal/bin
  env:
    PPC_CONFIG_PATH: /usr/lib/sdk/freepascal/etc
    FPCDIR: /usr/lib/sdk/freepascal/fpcsrc
    FPC_DIR: /usr/lib/sdk/freepascal/fpcsrc
    LAZARUS_DIR: /usr/lib/sdk/freepascal/share/lazarus
default-branch: stable
command: cudatext
finish-args:
  - --socket=x11
  - --socket=wayland
  - --filesystem=home
  - --device=dri
  - --share=ipc
  - --share=network
modules:
  - name: qt5pas
    sources:
      - type: archive
        url: https://gitlab.com/freepascal.org/lazarus/lazarus/-/archive/lazarus_2_2_0/lazarus-lazarus_2_2_0.tar.gz
        sha256: 37867f20be348787f1d783d0867573a838a448e19d36dd6e3b5cd71763c38db5
        dest: src/lazarus
    buildsystem: simple
    build-commands:
      - cp -r src/lazarus/lcl/interfaces/qt5/cbindings/. .
      - sed -e"s/target.path = .\+/target.path = '\/app\/lib'/" -i ./Qt5Pas.pro
      - qmake -makefile
      - make -j
      - make install

  - name: cudatext
    sources:
      - type: archive
        url: https://github.com/bgrabitmap/bgrabitmap/archive/refs/tags/v11.5.3.tar.gz
        sha256: cc23fb6ef8c2bbfd4f454774a47071e93cad214cf0197fede29c0057ef49fc80
        dest: src/bgrabitmap
      - type: archive
        url: https://github.com/Alexey-T/EncConv/archive/refs/tags/2023.01.02.tar.gz
        sha256: a535e1e2fdb18fd6368de1856e0be4da91f371edb84bbb576ec80c0efbbd1c0b
        dest: src/EncConv
      - type: archive
        url: https://github.com/Alexey-T/ATBinHex-Lazarus/archive/refs/tags/2022.06.14.tar.gz
        sha256: 6731b92a33e5e854d80da9af7184f4cbbde3897118a9b82bf017657a9cd39421
        dest: src/ATBinHex-Lazarus
      - type: archive
        url: https://github.com/Alexey-T/ATFlatControls/archive/refs/tags/2023.05.07.tar.gz
        sha256: 4bb9b4b62e3be6c75254ef524018f14fc734ff65bbac16eecd9dc9907ddf4a3f
        dest: src/ATFlatControls
      - type: archive
        url: https://github.com/Alexey-T/ATSynEdit/archive/refs/tags/2023.05.13.tar.gz
        sha256: 1d7b9971c608782216c70665c05bc7e2c4f0e002e60803e29d3c1b190b980b9a
        dest: src/ATSynEdit
      - type: archive
        url: https://github.com/Alexey-T/ATSynEdit_Cmp/archive/refs/tags/2023.05.12.tar.gz
        sha256: 62739d9821b78ef83c7b6e44da5db3ff21f9498a4eda62188eafd9a1d91c32a6
        dest: src/ATSynEdit_Cmp
      - type: archive
        url: https://github.com/Alexey-T/EControl/archive/refs/tags/2023.04.18.tar.gz
        sha256: 9a5ca7392c5f5f5d4ebe7c77a53f9c8845a05c81bf3c87a7db7d2db4d9eb1e82
        dest: src/EControl
      - type: archive
        url: https://github.com/Alexey-T/ATSynEdit_Ex/archive/refs/tags/2023.05.12.tar.gz
        sha256: 492b481bd2a30d08c4fa384bdd0d9cdea0adbcaef399b922216338d6d871a466
        dest: src/ATSynEdit_Ex
      - type: archive
        url: https://github.com/Alexey-T/Python-for-Lazarus/archive/refs/tags/2023.01.02.tar.gz
        sha256: 26b7e1794372e764f8c0d285063a7285f6b1efa7d04564cd69bece245d692fa4
        dest: src/Python-for-Lazarus
      - type: archive
        url: https://github.com/Alexey-T/Emmet-Pascal/archive/refs/tags/2022.09.18.tar.gz
        sha256: 00cc338f891e039a6ba9493d995c9dee2c779b3629e95e65f59c818a55a78478
        dest: src/Emmet-Pascal
      - type: archive
        url: https://github.com/Alexey-T/CudaText/archive/refs/tags/1.194.0.tar.gz
        sha256: de8499bf69e01b673f725f045e18865f1a1b69cd3d0ea28cf795bb5bc37944fe
        dest: src/CudaText
      - type: file
        path: io.github.cudatext.CudaText-Qt5.appdata.xml
    buildsystem: simple
    build-options:
      arch:
        x86_64:
          env:
            PPC: ppcx64
        aarch64:
          env:
            PPC: ppca64
    build-commands:
      - lazbuild --ws=qt5 -q --compiler=$PPC --pcp=. --lazarusdir="$LAZARUS_DIR" "./src/bgrabitmap/bgrabitmap/bgrabitmappack.lpk"
      - lazbuild --ws=qt5 -q --pcp=. --lazarusdir="$LAZARUS_DIR" "./src/EncConv/encconv/encconv_package.lpk"
      - lazbuild --ws=qt5 -q --pcp=. --lazarusdir="$LAZARUS_DIR" "./src/ATBinHex-Lazarus/atbinhex/atbinhex_package.lpk"
      - lazbuild --ws=qt5 -q --pcp=. --lazarusdir="$LAZARUS_DIR" "./src/ATFlatControls/atflatcontrols/atflatcontrols_package.lpk"
      - lazbuild --ws=qt5 -q --pcp=. --lazarusdir="$LAZARUS_DIR" "./src/ATSynEdit/atsynedit/atsynedit_package.lpk"
      - lazbuild --ws=qt5 -q --pcp=. --lazarusdir="$LAZARUS_DIR" "./src/ATSynEdit_Cmp/atsynedit_cmp/atsynedit_cmp_package.lpk"
      - lazbuild --ws=qt5 -q --pcp=. --lazarusdir="$LAZARUS_DIR" "./src/EControl/econtrol/econtrol_package.lpk"
      - lazbuild --ws=qt5 -q --pcp=. --lazarusdir="$LAZARUS_DIR" "./src/ATSynEdit_Ex/atsynedit_ex/atsynedit_ex_package.lpk"
      - lazbuild --ws=qt5 -q --pcp=. --lazarusdir="$LAZARUS_DIR" "./src/Python-for-Lazarus/python4lazarus/python4lazarus_package.lpk"
      - lazbuild --ws=qt5 -q --pcp=. --lazarusdir="$LAZARUS_DIR" "./src/Emmet-Pascal/emmet/emmet_package.lpk"
      # Replace references to /usr/share/cudatext with correct path, prior to compiling CudaText
      - sed -i -e"s/\/usr\/share\/cudatext/\\$FLATPAK_DEST\/share\/cudatext/g" src/CudaText/app/proc_globdata.pas
      - lazbuild --ws=qt5 -q --pcp=. --lazarusdir="$LAZARUS_DIR" "./src/CudaText/app/cudatext.lpi"
      - install -Dm755 src/CudaText/app/cudatext -t $FLATPAK_DEST/bin
      # Install all data and plugins
      - mkdir -p $FLATPAK_DEST/share/cudatext
      - cp -r src/CudaText/app/data $FLATPAK_DEST/share/cudatext/
      - cp -r src/CudaText/app/py $FLATPAK_DEST/share/cudatext/
      - cp -r src/CudaText/app/settings_default $FLATPAK_DEST/share/cudatext/
      # Desktop file and icon - desktop file needs to have the icon name corrected first (and carriage-returns removed)
      - sed -i -e"s/\r//g" src/CudaText/setup/debfiles/cudatext.desktop
      - sed -i -e"s/Icon=cudatext-512/Icon=io.github.cudatext.CudaText\-Qt5/" src/CudaText/setup/debfiles/cudatext.desktop
      - install -D src/CudaText/setup/debfiles/cudatext.desktop $FLATPAK_DEST/share/applications/io.github.cudatext.CudaText-Qt5.desktop
      - install -D src/CudaText/setup/debfiles/cudatext-512.png $FLATPAK_DEST/share/icons/hicolor/512x512/apps/io.github.cudatext.CudaText-Qt5.png
      - install -D io.github.cudatext.CudaText-Qt5.appdata.xml $FLATPAK_DEST/share/metainfo/io.github.cudatext.CudaText-Qt5.metainfo.xml
